CONST Domain = "LDAP://dc=CE,dc=RT,dc=RU" CONST strOU = "ce.RT.RU/MRF Center/DR/Users/New_Accounts"CONST strMaiboxBase = "CEDR_MAIN02_DB"CONST strDomainController = "scedr07dc001.ce.rt.ru"CONST strExchServer = "SCEDR07MBX01.ce.rt.ru"CONST strCustomAttribute13 = "dr"'*****************************************************************Dim ConnectionDim RecordsetDim SQLDim strSelectDim strFileDim objFSODim objFilePublic NewUserPublic strLoginPublic strFullNamePublic strFirstNamePublic strLastNamePublic strFamilyPublic strDescriptionPublic strReasonPublic psFileOutputDim arrDataDim objProgressMsg'***** START SCRIPT *****Set wshNetwork = WScript.CreateObject( "WScript.Network" )strCreatorName = wshNetwork.UserDomain & "\" & wshNetwork.UserNamestrPrompt = vbCrLf  & vbCrLf  & "Введите ФИО пользователя:"strUserName = "<ФИО>"strPrompt = vbCrLf  & vbCrLf  & "Введите ФИО пользователя:"strTitle = "Создание учетной записи в домене " & strOUstrUserName = InputBox(strPrompt,strTitle,strUserName)If (strUserName <> "<ФИО>") And (strUserName <> "") Then	AddUserEnd If'	Wscript.Echo strUserName'***** END SCRIPT *****'************** Sub AddUser ************************Sub AddUser'	MsgBox "Start Sub AddUser"'	Find User In Active Directory	strMsgBox = ""	Set objConnection = CreateObject("ADODB.Connection") 	objConnection.Open "Provider=ADsDSOObject;" 	Set objCommand = CreateObject("ADODB.Command") 	objCommand.ActiveConnection = objConnection 	objCommand.CommandText = _		"SELECT distinguishedName FROM '" & Domain & "' WHERE objectCategory='person' " & _		"AND objectClass='user'" & _		"AND cn = '" & strUserName & "*'" 	Set objRecordSet = objCommand.Execute	On Error Resume Next	objRecordSet.MoveFirst	If Err.Number = 0 Then 		Do Until objRecordSet.EOF			strdistinguishedName = objRecordSet.Fields("distinguishedName").Value'			Wscript.Echo strdistinguishedName			strName = objRecordSet.Fields("distinguishedName").Value			strName = Right(strName,Len(strName)-3)'			Wscript.Echo "strName = " & UCase(strName) & vbCrLf & "strUserName = " & UCase(strUserName)'			Wscript.Echo Instr(1,UCase(strName),UCase(strUserName))			If  Instr(1,UCase(strName),UCase(strUserName)) = 1 Then'				Wscript.Echo strName				Set objUser = GetObject("LDAP://" & strdistinguishedName)				strTitle = "Найден пользователь! Создавать нового?"'				strMsgBox = "Найден пользователь!" & vbCrLf & vbCrLf				strMsgBox = strMsgBox & objUser.displayName & vbCrLf  & vbCrLf						strMsgBox = strMsgBox & "E-Mail:		" & objUser.mail & vbCrLf								strMsgBox = strMsgBox & "Должность:	" & objUser.title & vbCrLf					strMsgBox = strMsgBox & "ERP_iD:		" & objUser.employeeID & vbCrLf & vbCrLf & vbCrLf							End If			objRecordSet.MoveNext		Loop				result = MsgBox(strMsgBox,4,strTitle)				If result = vbYes Then'			Wscript.Echo "Надо создавать нового!"			NeedCreateUser = True		Else'			Wscript.Echo "НЕ Надо создавать нового!"			NeedCreateUser = False		End If			Else'		result = MsgBox("Пользователь не найден!",0,strTitle)		NeedCreateUser = True	End If		If NeedCreateUser Then '***** Create Login and E-Mail Name *******************************************************		CreateLoginName'Wscript.Echo "|" & strFirstName & "|"'		Wscript.Echo strLogin		strReason = ""				Do					strPrompt = vbCrLf  & vbCrLf  & "Введите номер заявки!" & vbCrLf  & vbCrLf & strFullName & vbCrLf & strLogin & "@RT.RU" & vbCrLf & vbCrLf & "Заявка №:"			strTitle = "Создание учетной записи в домене " & strOU			strReason = InputBox(strPrompt,strTitle,strDescription)'			Wscript.Echo strReason							Loop While strReason = ""		strDescription = "Заявка № " & strReason & " " & Date'		Wscript.Echo strDescription		If strDescription <> "" Then'***** Create User and E-Mail *******************************************************				If CreateNewUser Then'				Wscript.Echo "Пользователь создан!"			End If		End If	End If	End Sub	'MsgBox "New User Done"'Wscript.Quit' End of Script *****************************************************************' ***** Проверка наличия учетной записи *****************************************Sub AddNewUser()    strdistinguishedName = objRecordSet.Fields("distinguishedName").Value'	Wscript.Echo strdistinguishedName	Set objUser = GetObject("LDAP://" & strdistinguishedName)'	Wscript.Echo objUser.displayName	If Err.Number = 0 Then		Err.Clear		On Error GoTo 0			Const ADS_PROPERTY_UPDATE = 2 		If NOT objUser.AccountDisabled Then			If CStr(objUser.employeeID) <> CStr(arrData(BaseERPiD,j)) Then'				strLine = strLine & arrData(BaseERPiD,j)				NewUser = True'				Wscript.Echo "Двойник: " & objUser.displayName			End If		End If	End IfEnd Sub'***** Формирование логина учетной записи ***************************************************Sub CreateLoginNamestrUserName = Trim(LCase(strUserName))strFamily = Trim(Left(strUserName,InStr(strUserName," ")))'Wscript.Echo "|" & strFamily & "|"strUserName = Trim(Right(strUserName,Len(strUserName)-InStr(strUserName," ")))'Wscript.Echo "|" & strUserName & "|"strFirstName = Trim(Left(strUserName,InStr(strUserName," ")))'Wscript.Echo "|" & strFirstName & "|"strLastName = Trim(Right(strUserName,Len(strUserName)-InStr(strUserName," ")))'Wscript.Echo "|" & strLastName & "|"strFamily = Ucase(Left(strFamily,1)) & Right(strFamily,Len(strFamily)-1)strFirstName = Ucase(Left(strFirstName,1)) & Right(strFirstName,Len(strFirstName)-1)strLastName = Ucase(Left(strLastName,1)) & Right(strLastName,Len(strLastName)-1)'Wscript.Echo strFamily & " " & strFirstName & " " & strLastNamestrFullName = strFamily & " " & strFirstName & " " & strLastName'***** ТранслитерацияstrFamilyEN = strFamilystrFirstNameEN = strFirstNamestrLastNameEN = strLastNamestrFamilyEN = Translit(strFamilyEN)strFirstNameEN = Translit(strFirstNameEN)strLastNameEN = Translit(strLastNameEN)'Wscript.Echo strFamilyEN & " " & strFirstNameEN & " " & strLastNameENstrLogin = strFirstNameEN & "." & strFamilyENIf Len(strLogin) > 20 Then	strLogin = Left(strFirstNameEN,1) &  "." & strFamilyEN	If Len(strLogin) > 20 Then		strLogin = strFamilyEN		If Len(strLogin) > 20 Then			strLogin = Left(strFamilyEN,20)		End If	end IfEnd IfIf NewUPN(strLogin) Then'	Wscript.Echo "Можно создавать: " & strLoginElse'	Wscript.Echo "Уже существует!!! " & strLogin	strLogin = strFirstNameEN & "." & Left(strLastNameEN,1) & "." & strFamilyEN	If Len(strLogin) > 20 Then		strLogin = Left(strFirstNameEN,1) & "." & Left(strLastNameEN,1) & "." & strFamilyEN	End If	If NewUPN(strLogin) Then'		Wscript.Echo "Можно создавать: " & strLogin	Else		strLogin = Replace(strLogin, ".", "_", 1, -1 , vbTextCompare)		If NewUPN(strLogin) Then'			Wscript.Echo "Можно создавать: " & strLogin		Else			strLogin = Replace(strLogin,"_","", 1, -1 , vbTextCompare)			If NewUPN(strLogin) Then'				Wscript.Echo "Можно создавать: " & strLogin			Else				Wscript.Echo "НЕ МОГУ ПОДОБРАТЬ ЛОГИН!!! : " & strLogin				Wscript.Quit			End If		End If	End If	End If 'Wscript.Echo "Можно создавать: " & strLoginEnd Sub'***** Функция транслитерации ****************************************************************************************************Private Function Translit(strName)    iRussian = "абвгдеёжзийклмнопрстуфхцчшщъыьэюя"    iTranslit = Array("", "a", "b", "v", "g", "d", "e", "yo", "zh", "z", "i", "y", "k", "l", "m", "n", "o", "p", "r", "s", "t", "u", "f", "kh", "ts", "ch", "sh", "sch", "", "y", "", "e", "yu", "ya")    strName = LCase(strName)	If strName <> "" Then		For intI = 1 To Len(strName)			For iCount = 1 To 33				strTemp = Replace(Mid(strName, intI, 1), Mid(iRussian, iCount, 1), iTranslit(iCount), 1, -1 , vbTextCompare)				If Mid(strName, intI, 1) <> strTemp Or Mid(strName, intI, 1) = " " Or Mid(strName, intI, 1) = "-" Then					strTemp2 = strTemp2 & strTemp					Exit For				End If			Next 'iCount		Next 'intI	End If	If strName <> "" Then		Translit = Ucase(Left(strTemp2,1)) & Right(strTemp2,Len(strTemp2)-1)	Else		Translit = ""	End If		End Function'***** Check UPN and E-Mail ******************************************************************************************************'Public Private Function NewUPN(strLogin)Dim oConnection 'As ADODB.ConnectionDim oRecordset 'As ADODB.RecordsetDim strQuery 'As StringDim strUPNMail 'As StringDim oCont 'As IADsContainerDim oGC 'As IADsDim strADsPath 'As StringstrUPNMail = strLogin & "@RT.RU"' Wscript.Echo "Check: " & strUPNMailUPNFound = TrueMailFound = True'Find the Global Catalog serverSet oCont = GetObject("GC:")For Each oGC In oCont	strADsPath = oGC.ADsPathNextSet oConnection = CreateObject("ADODB.Connection")Set oRecordset = CreateObject("ADODB.Recordset")oConnection.Provider = "ADsDSOObject"  'The ADSI OLE-DB provideroConnection.Open "ADs Provider"strQuery = "<" & strADsPath & ">;(&(objectClass=user)(objectCategory=person)(userprincipalName=" & strUPNMail & "));userPrincipalName,cn,distinguishedName;subtree"Set oRecordset = oConnection.Execute(strQuery)If oRecordset.EOF And oRecordset.BOF Then'  MsgBox "No duplicate UPN found: " & strUPNMail	UPNFound = FalseElse	While Not oRecordset.EOF'		MsgBox "UPN: " & oRecordset.Fields("userPrincipalName") & " found!" & vbLf & oRecordset.Fields("cn") & " located at " & oRecordset.Fields("distinguishedName")		oRecordset.MoveNext	Wend	UPNFound = TrueEnd IfSet oCont = NothingSet oGC = NothingSet oRecordset = NothingSet oConnection = NothingSet oConnection = CreateObject("ADODB.Connection")Set oRecordset = CreateObject("ADODB.Recordset")oConnection.Provider = "ADsDSOObject"  'The ADSI OLE-DB provideroConnection.Open "ADs Provider"strQuery = "<" & strADsPath & ">;(&(objectClass=user)(objectCategory=person)(Mail=" & strUPNMail & "));Mail,cn,distinguishedName;subtree"Set oRecordset = oConnection.Execute(strQuery)If oRecordset.EOF And oRecordset.BOF Then'  MsgBox "No duplicate Mail found"	MailFound = FalseElse	While Not oRecordset.EOF'		MsgBox "E-Mail: " & oRecordset.Fields("Mail") & " found!" & vbLf & oRecordset.Fields("cn") & " located at " & oRecordset.Fields("distinguishedName")		oRecordset.MoveNext	Wend	MailFound = TrueEnd IfSet oCont = NothingSet oGC = NothingSet oRecordset = NothingSet oConnection = NothingIf UPNFound OR MailFound Then	NewUPN = FalseElse	NewUPN = TrueEnd If	End Function'***** Create User **************************************************************************************************************Public Function CreateNewUser'Option ExplicitstrEMail = strLogin & "@rt.ru"'Dim strEXcommandstrEXCHcommand = "New-Mailbox -DomainController " & strDomainControllerstrEXCHcommand = strEXCHcommand & " -Name " & "'" & strFullName & "'"strEXCHcommand = strEXCHcommand & " -FirstName " & "'" & strFirstName & "'"strEXCHcommand = strEXCHcommand & " -LastName " & "'" & strFamily & "'"strEXCHcommand = strEXCHcommand & " -Alias " & strLoginstrEXCHcommand = strEXCHcommand & " -UserPrincipalName " & strEMailstrEXCHcommand = strEXCHcommand & " -Password (ConvertTo-SecureString Qwerty1! -AsPlainText -Force)"strEXCHcommand = strEXCHcommand & " -OrganizationalUnit " & "'" & strOU & "'"strEXCHcommand = strEXCHcommand & " -Database " & "'" & strMaiboxBase & "'" strEXCHcommand = strEXCHcommand & " -ResetPasswordOnNextLogon 1"strEXCHcommand = strEXCHcommand & vbCRLF & "import-module ActiveDirectory"strEXCHcommand = strEXCHcommand & vbCRLF & "Set-ADUser -Server " & strDomainController & " -Identity " & strLogin & " -Description '" & strDescription & "' -Add @{extensionAttribute8='" & strReason & "';extensionAttribute9='" & strCreatorName & "';extensionAttribute13='" & strCustomAttribute13 & "'}"psFileOutput = ".\Log\" & strLogin & ".ps1"set objFSO = CreateObject("Scripting.FileSystemObject")Set objFile = objFSO.OpenTextFile(psFileOutput, 2, True)'	WScript.Echo strEXCHcommandobjFile.WriteLine strEXCHcommandobjFile.ClosestrPS = "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -command "".'C:\Program Files\Microsoft\Exchange Server\V14\bin\RemoteExchange.ps1'; Connect-ExchangeServer " & strExchServer & "; " & psFileOutput & """" 'WScript.Echo strPSSet objShell = CreateObject("WScript.Shell")strWindowTitle = "Создание пользователя"ProgressMsg "Создается пользователь, ждите...", strWindowTitleobjShell.Run strPS,1,True ProgressMsg "Пользователь создан!", strWindowTitle'***** Hide From AddressBook *****'strEXCHcommand = "Set-Mailbox -Identity " & "'" & strFullName & "'"'strEXCHcommand = strEXCHcommand &  " -DomainController " & strDomainController & " -HiddenFromAddressListsEnabled $true"'strPS = "powershell.exe -ExecutionPolicy bypass -ImportSystemModules ; " & strEXCHcommand''WScript.Echo strPS'Set objShell = CreateObject("WScript.Shell")'objShell.Run strPS,1,True '***** Set EmployeeID *****'strEXCHcommand = "dsmod user (Get-Mailbox " & strEMail & " -DomainController " & strDomainController &").DistinguishedName -empid " & arrData(BaseERPiD,j) & " -s " & 'strDomainController'strPS = "powershell.exe -ExecutionPolicy bypass -ImportSystemModules ; " & strEXCHcommand''WScript.Echo strPS'Set objShell = CreateObject("WScript.Shell")'objShell.Run strPS,1,True CreateNewUser = TrueEnd Function'*****  ************************Function ProgressMsg( strMessage, strWindowTitle )' Written by Denis St-Pierre' Displays a progress message box that the originating script can kill in both 2k and XP' If StrMessage is blank, take down previous progress message box' Using 4096 in Msgbox below makes the progress message float on top of things' CAVEAT: You must have   Dim ObjProgressMsg   at the top of your script for this to work as described    Set wshShell = WScript.CreateObject( "WScript.Shell" )    strTEMP = wshShell.ExpandEnvironmentStrings( "%TEMP%" )    If strMessage = "" Then        ' Disable Error Checking in case objProgressMsg doesn't exists yet        On Error Resume Next        ' Kill ProgressMsg        objProgressMsg.Terminate( )        ' Re-enable Error Checking        On Error Goto 0        Exit Function    End If    Set objFSO = CreateObject("Scripting.FileSystemObject")    strTempVBS = strTEMP + "\" & "Message.vbs"     'Control File for reboot    ' Create Message.vbs, True=overwrite    Set objTempMessage = objFSO.CreateTextFile( strTempVBS, True )    objTempMessage.WriteLine( "MsgBox""" & strMessage & """, 4096, """ & strWindowTitle & """" )    objTempMessage.Close    ' Disable Error Checking in case objProgressMsg doesn't exists yet    On Error Resume Next    ' Kills the Previous ProgressMsg    objProgressMsg.Terminate( )    ' Re-enable Error Checking    On Error Goto 0    ' Trigger objProgressMsg and keep an object on it    Set objProgressMsg = WshShell.Exec( "%windir%\system32\wscript.exe " & strTempVBS )    Set wshShell = Nothing    Set objFSO   = NothingEnd Function